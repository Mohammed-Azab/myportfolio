<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPC Controller Animation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/MotionPathPlugin.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #0a0a0a;
            overflow-x: hidden;
        }
        
        .code-editor {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
        }
        
        .terminal {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
        }
        
        .syntax-keyword { color: #c586c0; }
        .syntax-type { color: #4ec9b0; }
        .syntax-string { color: #ce9178; }
        .syntax-comment { color: #6a9955; }
        .syntax-function { color: #dcdcaa; }
        .syntax-number { color: #b5cea8; }
        
        .terminal-text {
            color: #00ff00;
        }
        
        .cursor {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .glow {
            filter: drop-shadow(0 0 10px currentColor);
        }
        
        .neon-track {
            stroke: #00ffff;
            stroke-width: 2;
            fill: none;
            filter: drop-shadow(0 0 15px #00ffff);
        }
        
        .neon-track-outer {
            stroke: #00ffff;
            stroke-width: 3;
            fill: none;
            filter: drop-shadow(0 0 15px #00ffff);
        }
        
        .neon-track-inner {
            stroke: #00ffff;
            stroke-width: 2;
            fill: none;
            filter: drop-shadow(0 0 10px #00ffff);
            opacity: 0.8;
        }
        
        .racing-line {
            stroke: #ff6b00;
            stroke-width: 1;
            fill: none;
            stroke-dasharray: 5,5;
            opacity: 0.6;
            filter: drop-shadow(0 0 5px #ff6b00);
        }
        
        .track-selector {
            transition: all 0.3s ease;
        }
        
        .track-selector:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        .track-selector.active {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ffff;
        }
        
        .porsche-icon {
            width: 40px;
            height: 25px;
            filter: drop-shadow(0 0 10px #ff6b00);
        }
        
        .terminal-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transform: translateY(100%);
            transition: transform 0.8s ease-in-out;
        }
        
        .terminal-overlay.show {
            transform: translateY(0);
        }
        
        .code-container {
            position: relative;
            height: 500px;
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-green-400">
                MPC Controller Simulation
            </h1>
            <p class="text-gray-400">ROS2 Model Predictive Control for Autonomous Racing</p>
        </div>

        <!-- Main Content -->
        <div class="code-container mb-8">
            <!-- Code Editor -->
            <div class="code-editor p-4 h-full">
                <div class="flex items-center mb-4 border-b border-gray-700 pb-2">
                    <div class="flex space-x-2">
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    </div>
                    <span class="ml-4 text-sm text-gray-400">mpc_controller.cpp</span>
                </div>
                <pre id="code-content" class="text-sm leading-relaxed h-96 overflow-auto"></pre>
            </div>

            <!-- Terminal Overlay -->
            <div class="terminal-overlay terminal p-4">
                <div class="flex items-center mb-4 border-b border-gray-700 pb-2">
                    <span class="text-sm text-gray-400">Terminal</span>
                </div>
                <div class="h-32">
                    <div class="terminal-text">
                        <span class="text-gray-400">user@autonomous-racing:~/mpc_ws$</span>
                        <span id="terminal-command"></span>
                        <span id="terminal-cursor" class="cursor">_</span>
                    </div>
                    <div id="terminal-output" class="mt-4 terminal-text text-xs"></div>
                </div>
            </div>
        </div>

        <!-- Track Selection -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4 text-cyan-400">Select Racing Track:</h3>
            <div class="flex flex-wrap gap-4">
                <button class="track-selector active bg-gray-800 border border-gray-600 px-4 py-2 rounded" data-track="silverstone">
                    Silverstone Circuit
                </button>
                <button class="track-selector bg-gray-800 border border-gray-600 px-4 py-2 rounded" data-track="monaco">
                    Monaco GP
                </button>
                <button class="track-selector bg-gray-800 border border-gray-600 px-4 py-2 rounded" data-track="spa">
                    Spa-Francorchamps
                </button>
                <button class="track-selector bg-gray-800 border border-gray-600 px-4 py-2 rounded" data-track="figure8">
                    Figure-8 Test Track
                </button>
            </div>
        </div>

        <!-- Race Track Visualization -->
        <div class="bg-black border border-gray-700 rounded-lg p-8">
            <h3 class="text-xl font-semibold mb-4 text-cyan-400">Live Track Simulation</h3>
            <div class="flex justify-center">
                <svg id="race-track" width="800" height="600" viewBox="0 0 800 600" class="max-w-full h-auto">
                    <!-- Track paths will be dynamically added here -->
                    <!-- Porsche 911 Detailed Icon -->
                    <g id="porsche-car" class="porsche-icon">
                        <!-- Car Body -->
                        <path d="M5,12 L35,12 L38,10 L42,10 L45,12 L45,18 L42,20 L38,20 L35,18 L5,18 L2,16 L2,14 Z" 
                              fill="#ff6b00" stroke="#ff4500" stroke-width="0.5"/>
                        
                        <!-- Windshield -->
                        <path d="M8,12 L32,12 L30,8 L10,8 Z" fill="#87CEEB" opacity="0.7"/>
                        
                        <!-- Side Windows -->
                        <path d="M6,14 L8,12 L10,12 L8,16 Z" fill="#87CEEB" opacity="0.5"/>
                        <path d="M32,12 L34,12 L36,14 L34,16 Z" fill="#87CEEB" opacity="0.5"/>
                        
                        <!-- Front Headlights -->
                        <circle cx="3" cy="13" r="1.5" fill="#ffff99"/>
                        <circle cx="3" cy="17" r="1.5" fill="#ffff99"/>
                        
                        <!-- Rear Lights -->
                        <circle cx="47" cy="13" r="1" fill="#ff0000"/>
                        <circle cx="47" cy="17" r="1" fill="#ff0000"/>
                        
                        <!-- Wheels -->
                        <circle cx="10" cy="20" r="3" fill="#333" stroke="#666" stroke-width="0.5"/>
                        <circle cx="10" cy="20" r="2" fill="#888"/>
                        <circle cx="35" cy="20" r="3" fill="#333" stroke="#666" stroke-width="0.5"/>
                        <circle cx="35" cy="20" r="2" fill="#888"/>
                        
                        <!-- Door Lines -->
                        <line x1="15" y1="12" x2="13" y2="18" stroke="#ff4500" stroke-width="0.5"/>
                        <line x1="25" y1="12" x2="27" y2="18" stroke="#ff4500" stroke-width="0.5"/>
                        
                        <!-- Roof Line -->
                        <path d="M10,8 L32,8 L30,6 L12,6 Z" fill="#ff4500"/>
                        
                        <!-- Side Mirrors -->
                        <circle cx="6" cy="11" r="1" fill="#333"/>
                        <circle cx="36" cy="11" r="1" fill="#333"/>
                    </g>
                </svg>
            </div>
            <div id="status" class="mt-4 text-center text-cyan-400 font-mono"></div>
        </div>
    </div>

    <script>
        // Code content to be typed
        const codeContent = `<span class="syntax-comment">// MPC Controller Node for Autonomous Racing</span>
<span class="syntax-keyword">#include</span> <span class="syntax-string">&lt;rclcpp/rclcpp.hpp&gt;</span>
<span class="syntax-keyword">#include</span> <span class="syntax-string">&lt;geometry_msgs/msg/twist.hpp&gt;</span>
<span class="syntax-keyword">#include</span> <span class="syntax-string">&lt;nav_msgs/msg/odometry.hpp&gt;</span>

<span class="syntax-keyword">class</span> <span class="syntax-type">MPCController</span> : <span class="syntax-keyword">public</span> <span class="syntax-type">rclcpp::Node</span> {
<span class="syntax-keyword">private</span>:
    <span class="syntax-type">rclcpp::Publisher</span>&lt;<span class="syntax-type">geometry_msgs::msg::Twist</span>&gt;::<span class="syntax-type">SharedPtr</span> cmd_pub_;
    <span class="syntax-type">rclcpp::Subscription</span>&lt;<span class="syntax-type">nav_msgs::msg::Odometry</span>&gt;::<span class="syntax-type">SharedPtr</span> odom_sub_;
    
    <span class="syntax-comment">// MPC Parameters</span>
    <span class="syntax-type">double</span> prediction_horizon_ = <span class="syntax-number">10.0</span>;
    <span class="syntax-type">double</span> control_horizon_ = <span class="syntax-number">5.0</span>;
    <span class="syntax-type">double</span> max_velocity_ = <span class="syntax-number">15.0</span>; <span class="syntax-comment">// m/s</span>

<span class="syntax-keyword">public</span>:
    <span class="syntax-function">MPCController</span>() : <span class="syntax-function">Node</span>(<span class="syntax-string">"mpc_controller"</span>) {
        cmd_pub_ = <span class="syntax-keyword">this</span>-><span class="syntax-function">create_publisher</span>&lt;<span class="syntax-type">geometry_msgs::msg::Twist</span>&gt;(
            <span class="syntax-string">"/cmd_vel"</span>, <span class="syntax-number">10</span>);
        
        odom_sub_ = <span class="syntax-keyword">this</span>-><span class="syntax-function">create_subscription</span>&lt;<span class="syntax-type">nav_msgs::msg::Odometry</span>&gt;(
            <span class="syntax-string">"/odom"</span>, <span class="syntax-number">10</span>,
            std::<span class="syntax-function">bind</span>(&<span class="syntax-type">MPCController</span>::<span class="syntax-function">odom_callback</span>, 
                     <span class="syntax-keyword">this</span>, std::<span class="syntax-type">placeholders</span>::_1));
        
        <span class="syntax-function">RCLCPP_INFO</span>(<span class="syntax-keyword">this</span>-><span class="syntax-function">get_logger</span>(), <span class="syntax-string">"MPC Controller initialized"</span>);
    }

    <span class="syntax-type">void</span> <span class="syntax-function">odom_callback</span>(<span class="syntax-keyword">const</span> <span class="syntax-type">nav_msgs::msg::Odometry::SharedPtr</span> msg) {
        <span class="syntax-comment">// Compute optimal control using MPC algorithm</span>
        <span class="syntax-type">auto</span> cmd = <span class="syntax-type">geometry_msgs::msg::Twist</span>();
        cmd.linear.x = <span class="syntax-function">compute_optimal_velocity</span>(msg);
        cmd.angular.z = <span class="syntax-function">compute_optimal_steering</span>(msg);
        cmd_pub_-><span class="syntax-function">publish</span>(cmd);
    }
};`;

        // Track definitions with double lines and racing line
        const tracks = {
            silverstone: {
                outer: "M80,300 Q180,180 350,230 Q520,280 620,180 Q720,80 770,180 Q770,370 670,420 Q520,470 350,420 Q180,370 80,300 Z",
                inner: "M120,300 Q200,220 350,270 Q500,320 600,220 Q680,140 710,220 Q710,330 630,380 Q500,410 350,380 Q200,330 120,300 Z",
                racing: "M100,300 Q190,200 350,250 Q510,300 610,200 Q700,110 740,200 Q740,350 650,400 Q510,440 350,400 Q190,350 100,300 Z",
                name: "Silverstone Circuit"
            },
            monaco: {
                outer: "M80,200 L320,200 Q420,200 470,250 L470,370 Q470,420 420,470 L180,470 Q130,470 80,420 L80,280 Q80,230 130,200 Z",
                inner: "M120,240 L300,240 Q360,240 390,270 L390,330 Q390,360 360,390 L200,390 Q170,390 140,360 L140,300 Q140,270 170,240 Z",
                racing: "M100,220 L310,220 Q390,220 430,260 L430,350 Q430,390 390,430 L190,430 Q150,430 110,390 L110,290 Q110,250 150,220 Z",
                name: "Monaco GP"
            },
            spa: {
                outer: "M80,350 Q180,230 350,280 Q520,330 620,230 Q720,130 770,230 Q820,330 720,430 Q620,480 470,430 Q320,380 200,430 Q80,380 80,350 Z",
                inner: "M120,350 Q200,270 350,320 Q500,370 600,270 Q680,170 710,270 Q740,370 680,410 Q600,440 470,410 Q340,380 220,410 Q120,380 120,350 Z",
                racing: "M100,350 Q190,250 350,300 Q510,350 610,250 Q700,150 740,250 Q780,350 700,420 Q610,460 470,420 Q330,380 210,420 Q100,380 100,350 Z",
                name: "Spa-Francorchamps"
            },
            figure8: {
                outer: "M150,250 C150,150 250,150 350,250 C450,350 550,350 650,250 C750,150 850,150 850,250 C850,350 750,350 650,250 C550,150 450,150 350,250 C250,350 150,350 150,250 Z",
                inner: "M180,250 C180,180 260,180 350,250 C440,320 520,320 620,250 C720,180 800,180 800,250 C800,320 720,320 620,250 C520,180 440,180 350,250 C260,320 180,320 180,250 Z",
                racing: "M165,250 C165,165 255,165 350,250 C445,335 535,335 635,250 C735,165 825,165 825,250 C825,335 735,335 635,250 C535,165 445,165 350,250 C255,335 165,335 165,250 Z",
                name: "Infinity Circuit"
            }
        };

        let currentTrack = 'silverstone';
        let isAnimating = false;

        // Initialize GSAP
        gsap.registerPlugin(MotionPathPlugin);

        // Typewriter effect for code (faster)
        function typeCode() {
            const codeElement = document.getElementById('code-content');
            const lines = codeContent.split('\n');
            let currentLine = 0;
            
            function typeLine() {
                if (currentLine < lines.length) {
                    const line = lines[currentLine];
                    codeElement.innerHTML += line + '\n';
                    currentLine++;
                    // Much faster typing - 50-100ms per line instead of 300-500ms
                    setTimeout(typeLine, 50 + Math.random() * 50);
                } else {
                    // Code typing finished, show terminal overlay and start terminal
                    setTimeout(() => {
                        showTerminalOverlay();
                        setTimeout(typeTerminalCommand, 500);
                    }, 300);
                }
            }
            
            typeLine();
        }

        // Show terminal overlay
        function showTerminalOverlay() {
            const terminal = document.querySelector('.terminal-overlay');
            terminal.classList.add('show');
        }

        // Terminal typing effect (faster)
        function typeTerminalCommand() {
            const command = "ros2 launch mpc_controller launch.py";
            const commandElement = document.getElementById('terminal-command');
            let currentChar = 0;
            
            function typeChar() {
                if (currentChar < command.length) {
                    commandElement.textContent += command[currentChar];
                    currentChar++;
                    // Faster typing - 50ms per character instead of 100ms
                    setTimeout(typeChar, 50);
                } else {
                    // Command typed, show output and start car animation
                    setTimeout(showTerminalOutput, 300);
                }
            }
            
            typeChar();
        }

        function showTerminalOutput() {
            const output = document.getElementById('terminal-output');
            const cursor = document.getElementById('terminal-cursor');
            cursor.style.display = 'none';
            
            const outputText = `[INFO] [launch]: All log files can be found below /root/.ros/log
[INFO] [mpc_controller]: MPC Controller initialized
[INFO] [mpc_controller]: Starting autonomous racing mode...
[INFO] [mpc_controller]: Vehicle positioned at starting line
[INFO] [mpc_controller]: Beginning race simulation...`;

            let currentChar = 0;
            function typeOutput() {
                if (currentChar < outputText.length) {
                    output.textContent += outputText[currentChar];
                    currentChar++;
                    // Much faster output typing
                    setTimeout(typeOutput, 10);
                } else {
                    // Terminal output complete, start car animation
                    setTimeout(() => {
                        startCarAnimation();
                        updateStatus("🏁 Race started! MPC Controller active.");
                    }, 500);
                }
            }
            
            typeOutput();
        }

        // Create track SVG
        function createTrack(trackKey) {
            const svg = document.getElementById('race-track');
            const track = tracks[trackKey];
            
            // Clear existing tracks
            const existingTracks = svg.querySelectorAll('.track-path, .track-group');
            existingTracks.forEach(track => track.remove());
            
            // Create track group for double lines
            const trackGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            trackGroup.setAttribute('class', 'track-group');
            
            // Create outer track line
            const outerPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            outerPath.setAttribute('d', track.outer);
            outerPath.setAttribute('class', 'track-path neon-track-outer');
            outerPath.setAttribute('fill', 'none');
            
            // Create inner track line
            const innerPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            innerPath.setAttribute('d', track.inner);
            innerPath.setAttribute('class', 'track-path neon-track-inner');
            innerPath.setAttribute('fill', 'none');
            
            // Create racing line (car follows this path)
            const racingPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            racingPath.setAttribute('d', track.racing);
            racingPath.setAttribute('class', 'track-path racing-line');
            racingPath.setAttribute('fill', 'none');
            racingPath.setAttribute('id', 'racing-path');
            
            trackGroup.appendChild(outerPath);
            trackGroup.appendChild(innerPath);
            trackGroup.appendChild(racingPath);
            
            svg.insertBefore(trackGroup, svg.firstChild);
        }

        // Start car animation
        function startCarAnimation() {
            if (isAnimating) return;
            
            isAnimating = true;
            const car = document.getElementById('porsche-car');
            const path = document.getElementById('racing-path');
            
            if (!path) {
                createTrack(currentTrack);
                setTimeout(startCarAnimation, 100);
                return;
            }
            
            // Reset car position
            gsap.set(car, { x: 0, y: 0, rotation: 0 });
            
            // Animate car along the path (faster and smoother)
            gsap.to(car, {
                duration: 6, // Faster lap time
                ease: "none",
                motionPath: {
                    path: "#racing-path",
                    autoRotate: true,
                    alignOrigin: "0.5 0.5"
                },
                onComplete: () => {
                    updateStatus("🏆 Lap completed! Starting next lap...");
                    setTimeout(() => {
                        if (isAnimating) startCarAnimation();
                    }, 500); // Shorter delay between laps
                }
            });
        }

        // Track selection
        function setupTrackSelection() {
            const trackButtons = document.querySelectorAll('.track-selector');
            
            trackButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Update active button
                    trackButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Stop current animation
                    isAnimating = false;
                    gsap.killTweensOf('#porsche-car');
                    
                    // Switch track
                    currentTrack = button.dataset.track;
                    createTrack(currentTrack);
                    
                    updateStatus(`🏁 Switched to ${tracks[currentTrack].name}. Starting race...`);
                    
                    // Start new animation
                    setTimeout(() => {
                        startCarAnimation();
                    }, 1000);
                });
            });
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Initialize everything
        function init() {
            createTrack(currentTrack);
            setupTrackSelection();
            updateStatus("💻 Compiling MPC Controller...");
            
            // Start the animation sequence (faster initial delay)
            setTimeout(typeCode, 500);
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
